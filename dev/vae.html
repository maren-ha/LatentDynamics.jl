<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>VAE model · LatentDynamics.jl</title><meta name="title" content="VAE model · LatentDynamics.jl"/><meta property="og:title" content="VAE model · LatentDynamics.jl"/><meta property="twitter:title" content="VAE model · LatentDynamics.jl"/><meta name="description" content="Documentation for LatentDynamics.jl."/><meta property="og:description" content="Documentation for LatentDynamics.jl."/><meta property="twitter:description" content="Documentation for LatentDynamics.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">LatentDynamics.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="index.html">Introduction</a></li><li><a class="tocitem" href="data.html">Data processing</a></li><li><a class="tocitem" href="dynamics.html">Dynamic model</a></li><li class="is-active"><a class="tocitem" href="vae.html">VAE model</a><ul class="internal"><li><a class="tocitem" href="#Defining-the-model"><span>Defining the model</span></a></li><li><a class="tocitem" href="#Training-the-model"><span>Training the model</span></a></li></ul></li><li><a class="tocitem" href="evaluation.html">Evaluation</a></li><li><a class="tocitem" href="plotting.html">Plotting</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="vae.html">VAE model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="vae.html">VAE model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/maren-ha/LatentDynamics.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/maren-ha/LatentDynamics.jl/blob/main/docs/src/vae.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="ODE-VAE-model"><a class="docs-heading-anchor" href="#ODE-VAE-model">ODE-VAE model</a><a id="ODE-VAE-model-1"></a><a class="docs-heading-anchor-permalink" href="#ODE-VAE-model" title="Permalink"></a></h1><p>We integrate the ODE-based dynamic model in the latent space of a VAE for flexible non-linear dimension reduction, reflecting the assumption of a lower-dimensional underlying dynamic process driving the observed measurements. The following functions are used to define, construct and train an ODE-VAE model. </p><p>To jointly optimize all components, i.e., the dynamic model and the VAE for dimension reduction, and the ODE-net for obtaining person-specific ODE parameters, we implement a joint loss function that incorporates all components and optimize it by stochastic gradient descent. This requires to differentiate through our ODE estimator and the calculation of time-dependent inverse-variance weights. Here, we exploit the flexible automatic differentiation system from <code>Zygote.jl</code> to simultaneously obtain gradients with respect to the VAE encoder and decoder parameters and the individual-specific dynamic model parameters in a straightforward way that requires minimal code adaptation. Zygote is specifically useful for that because of its very powerful source-to-source differentiation, that allows for differentiate through arbitrary Julia code, including the ODE solvers, user-defined structs, loops and recursion without any code refactoring or adaptation. For details, check out, e.g., <a href="https://arxiv.org/abs/1907.07587">Innes et al. (2019)</a>.</p><p>As a result of this joint optimization, the components can influence each other, such that a latent representation can be found that is automatically adapted to the underlying dynamics and the ODE system structures and regularizes the representation. </p><p>As our ODEs have analytical solutions, differentiation through the latent dynamics estimator does not require backpropagating gradients through a numerical ODE solving step. However, differentiable programming also allows for differentiating through ODE solvers in each loss function gradient update, which can be realized efficiently, e.g., using the <a href="https://arxiv.org/abs/1806.07366">adjoint sensitivity method</a>.</p><h2 id="Defining-the-model"><a class="docs-heading-anchor" href="#Defining-the-model">Defining the model</a><a id="Defining-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-the-model" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="LatentDynamics.odevae" href="#LatentDynamics.odevae"><code>LatentDynamics.odevae</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">odevae</code></pre><p>Struct for an ODE-VAE model, with the following fields:</p><ul><li><code>p</code>: number of VAE input dimensions, i.e., number of time-dependent variables</li><li><code>q</code>: number of input dimensions for the baseline neural net, i.e., number of baseline variables</li><li><code>zdim</code>: number of latent dimensions</li><li><code>ODEnet</code>: neural net to map baseline variables to individual-specific ODE parameters    (number of ODE parameters depends on the ODE system specified by the <code>dynamics</code> function)</li><li><code>encoder</code>: neural net to map input data to latent space</li><li><code>encodedμ</code>: neural net layer parameterizing the mean of the latent space</li><li><code>encodedlogσ</code>: neural net layer parameterizing the log variance of the latent space</li><li><code>decoder</code>: neural net to map latent variable to reconstructed input data</li><li><code>decodedμ</code>: neural net layer parameterizing the mean of the reconstructed input data</li><li><code>decodedlogσ</code>: neural net layer parameterizing the log variance of the reconstructed input data</li><li><code>dynamics</code>: one of <code>params_fullinhomogeneous</code>, <code>params_offdiagonalinhomogeneous</code>,    <code>params_diagonalinhomogeneous</code>, <code>params_driftonly</code>, <code>params_fullhomogeneous</code>,    <code>params_offdiagonalhomogeneous</code>, <code>params_diagonalhomogeneous</code>: function to map a parameter vector   (=the output of the <code>ODEnet</code>) to the system matrix and constant vector of the ODE system</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/maren-ha/LatentDynamics.jl/blob/195f2de927a7cffb8326f2e9eac0c03d0031e2c8/src/Model.jl#L128-L147">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="LatentDynamics.odevae-Tuple{ModelArgs}" href="#LatentDynamics.odevae-Tuple{ModelArgs}"><code>LatentDynamics.odevae</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">odevae(modelargs::ModelArgs)</code></pre><p>Function to initialize the ODE-VAE model according to the arguments passed in <code>modelargs</code>.</p><p>Returns an <code>odevae</code> model.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/maren-ha/LatentDynamics.jl/blob/195f2de927a7cffb8326f2e9eac0c03d0031e2c8/src/Model.jl#L236-L242">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="LatentDynamics.ModelArgs" href="#LatentDynamics.ModelArgs"><code>LatentDynamics.ModelArgs</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">ModelArgs</code></pre><p>Struct to store model arguments, can be constructed with keyword arguments to set the following fields:</p><ul><li><code>p</code>: number of VAE input dimensions, i.e., number of time-dependent variables</li><li><code>q</code>: number of input dimensions for the baseline neural net, i.e., number of baseline variables</li><li><code>zdim</code>: number of latent dimensions</li><li><code>dynamics</code>: one of <code>params_fullinhomogeneous</code>, <code>params_offdiagonalinhomogeneous</code>,    <code>params_diagonalinhomogeneous</code>, <code>params_driftonly</code>, <code>params_fullhomogeneous</code>,    <code>params_offdiagonalhomogeneous</code>, <code>params_diagonalhomogeneous</code>: function to map a parameter vector   (=the output of the <code>ODEnet</code>) to the system matrix and constant vector of the ODE system</li><li><code>seed</code>: random seed for reproducibility</li><li><code>bottleneck</code>: whether to use a bottleneck layer in the <code>ODEnet</code>    to reduce the number of effective parameters for higher-dimensional systems</li><li><code>init_scaled</code>: whether to initialize the <code>ODEnet</code> with scaled weights</li><li><code>scale_sigmoid</code>: scaling factor for the sigmoid function used to shift the ODE parameters    to a sensible range, acting as a prior</li><li><code>add_diagonal</code>: whether to add a diagonal transformation to output of the <code>ODEnet</code> to add   flexibility after the sigmoid transformation</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/maren-ha/LatentDynamics.jl/blob/195f2de927a7cffb8326f2e9eac0c03d0031e2c8/src/Model.jl#L162-L181">source</a></section></article><h2 id="Training-the-model"><a class="docs-heading-anchor" href="#Training-the-model">Training the model</a><a id="Training-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Training-the-model" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="LatentDynamics.LossArgs" href="#LatentDynamics.LossArgs"><code>LatentDynamics.LossArgs</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">LossArgs</code></pre><p>Struct to store loss arguments, can be constructed with keyword arguments to set the following fields:</p><ul><li><code>λ_μpenalty</code>: weight for the penalty that encourages consistency of the mean before and after solving the ODEs</li><li><code>λ_variancepenalty</code>: weight for the penalty on the variance of the ODE estimator</li><li><code>variancepenaltytype</code>: one of <code>:ratio_sum</code>, <code>:sum_ratio</code>, <code>:log_diff</code>:    type of penalty on the variance of the ODE estimator</li><li><code>variancepenaltyoffset</code>: offset used in the penalty on the variance of the latent space</li><li><code>firstonly</code>: whether to use only the first time point for solving the ODE (if <code>false</code>,    an ODE is solved with each time point as initial condition and the individual solutions are averaged)</li><li><code>weighting</code>: whether to calculate inverse-variance weights for the contribution of other time points    in the ODE trajectory estimator or use just equal weights for all ODE solutions</li><li><code>skipt0</code>: whether to skip the first time point in the ODE estimator    (to prevent the model from using just the initial condition and pushing the weights of all other solutions to zero)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/maren-ha/LatentDynamics.jl/blob/195f2de927a7cffb8326f2e9eac0c03d0031e2c8/src/Model.jl#L194-L209">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="LatentDynamics.loss" href="#LatentDynamics.loss"><code>LatentDynamics.loss</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">loss(X, Y, t, m::odevae; args::LossArgs)</code></pre><p>Compute the loss of the ODE-VAE model <code>m</code> on a batch of data, consisting of      time-dependent variables <code>X</code>, baseline variables <code>Y</code> and time point <code>t</code>. </p><p>Details of the loss function behaviour, including additional penalties, are controlled by the      keyword arguments <code>args</code> of type <code>LossArgs</code>, see <code>?LossArgs</code> for details.</p><p>Returns the mean ELBO, where the ODE estimator of the underlying trajectory is used to decode the latent      value at the time points <code>t</code> and obtain a reconstruction according to these smooth latent dynamics      as specified by the ODE system.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/maren-ha/LatentDynamics.jl/blob/195f2de927a7cffb8326f2e9eac0c03d0031e2c8/src/Model.jl#L386-L398">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="LatentDynamics.train_model!" href="#LatentDynamics.train_model!"><code>LatentDynamics.train_model!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">train_model!(m::odevae, 
    xs, xs_baseline, tvals, 
    lr, epochs, args::LossArgs; 
    selected_ids=nothing, 
    verbose::Bool=true, 
    plotting::Bool=true
    )</code></pre><p>Train the ODE-VAE model <code>m</code> on a dataset of time-dependent variables <code>xs</code>,      baseline variables <code>xs_baseline</code> and time points <code>tvals</code>. The structure of these      is assumed to be as in the <code>SMATestData</code> and <code>simdata</code> structs. </p><p><strong>Arguments</strong></p><ul><li><code>m</code>: the ODE-VAE model to train</li><li><code>xs</code>: a vector of matrices of time-dependent variables for each patient</li><li><code>xs_baseline</code>: a vector of vectors of baseline variables for each patient</li><li><code>tvals</code>: a vector of vectors of time points for each patient</li><li><code>lr</code>: the learning rate of the ADAM optimizer</li><li><code>epochs</code>: the number of epochs to train for</li><li><code>args</code>: arguments controlling the loss function behaviour, see <code>?LossArgs</code> for details</li><li><code>selected_ids</code>: the IDs of the patients to plot during training to monitor progress,   if <code>nothing</code> (default) then 12 random IDs are selected</li><li><code>verbose</code>: whether to print the epoch and loss value during training</li><li><code>plotting</code>: whether to visualize the learnt latent trajectories of selected patients    (those with the <code>selected_ids</code>)</li></ul><p><strong>Returns</strong></p><ul><li><code>m</code>: the trained ODE-VAE model</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/maren-ha/LatentDynamics.jl/blob/195f2de927a7cffb8326f2e9eac0c03d0031e2c8/src/Model.jl#L436-L465">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="dynamics.html">« Dynamic model</a><a class="docs-footer-nextpage" href="evaluation.html">Evaluation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Tuesday 9 January 2024 12:50">Tuesday 9 January 2024</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
